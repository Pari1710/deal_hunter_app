<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCR Property Pulse - AI Deal Analyzer</title>
    <style>
        /* --- NEW NEUTRAL COLOR SCHEME & FONTS --- */
        :root {
            --bg-light: #F8F9FA;
            --bg-white: #FFFFFF;
            --border-color: #DEE2E6;
            --text-dark: #212529;
            --text-muted: #6C757D;
            --accent-blue: #4A90E2;
            --accent-green: #28A745;
            --accent-yellow: #FFC107;
            --accent-red: #DC3545;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 30px; }

        /* --- HEADER --- */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background-color: rgba(255, 255, 255, 0.8); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); }
        .header .logo { font-size: 1.75rem; font-weight: 700; color: var(--text-dark); }
        .header .logo span { color: var(--accent-blue); }
        
        /* --- MAIN DASHBOARD & CARDS --- */
        .dashboard-section { padding: 40px 0; animation: fadeIn 0.8s ease-out; }
        h2 { font-size: 2.5rem; margin-bottom: 20px; color: var(--text-dark); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .kpi-card { background-color: var(--bg-white); padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .kpi-card h3 { font-size: 1rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        .kpi-card .metric-value { font-size: 2.5rem; font-weight: 700; color: var(--accent-blue); }

        /* --- TABLE & NEW FEATURES --- */
        .controls-and-table { background-color: var(--bg-white); padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; }
        .filter-group label { font-size: 0.9rem; color: var(--text-muted); margin-right: 10px; }
        .filter-group select { background-color: var(--bg-light); border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 1rem; }
        #compare-btn { background-color: var(--accent-blue); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: none; }
        
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table thead th { padding: 15px; text-align: left; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid var(--border-color); }
        #results-table tbody td { padding: 15px; border-bottom: 1px solid var(--border-color); }
        #results-table tbody tr:last-child td { border-bottom: none; }
        #results-table tbody tr:hover { background-color: #f8f9fa; }
        
        /* --- NEW Deal Strength Tags --- */
        .strength-tag { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 700; color: #fff; }
        .excellent { background-color: var(--accent-green); }
        .good { background-color: #20c997; }
        .fair { background-color: var(--accent-yellow); color: var(--text-dark); }
        .overpriced { background-color: var(--accent-red); }

        /* --- NEW Comparison Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 2000; animation: fadeIn 0.3s; }
        .modal-content { background: var(--bg-white); padding: 40px; border-radius: 16px; width: 90%; max-width: 900px; }
        .modal-close { float: right; background: none; border: none; font-size: 2rem; cursor: pointer; }
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; text-align: center; }
        .comparison-col h4 { font-size: 1rem; color: var(--text-muted); min-height: 40px; }
        .comparison-col p { font-size: 1.5rem; font-weight: 600; color: var(--accent-blue); }
        .comparison-col hr { border: none; border-top: 1px solid var(--border-color); margin: 15px 0; }
        
        #loader { text-align: center; padding: 80px; }
        .loader-pulse { width: 50px; height: 50px; margin: auto; border-radius: 50%; background-color: var(--accent-blue); animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">üèòÔ∏è NCR <span>Property Pulse</span></div>
    </header>

    <main class="container">
        <section class="dashboard-section">
            <div id="loader">
                <div class="loader-pulse"></div>
                <p style="margin-top: 20px; color: var(--text-muted);">Connecting to live market data...</p>
            </div>
            
            <div id="dashboard-content" style="display:none;">
                <div class="kpi-grid">
                    <div class="kpi-card"><h3>Deals in Database</h3><p class="metric-value" id="total-deals">--</p></div>
                    <div class="kpi-card"><h3>Avg. Cap Rate</h3><p class="metric-value" id="avg-cap-rate">--</p></div>
                    <div class="kpi-card"><h3>Avg. CoC Return</h3><p class="metric-value" id="avg-coc-return">--</p></div>
                </div>
                
                <div class="controls-and-table">
                    <div class="controls">
                        <div class="filter-group">
                            <label for="bedrooms-filter">Filter by Bedrooms:</label>
                            <select id="bedrooms-filter"></select>
                        </div>
                        <button id="compare-btn">Compare Selected Deals</button>
                    </div>
                    <table id="results-table">
                        <thead>
                            <tr><th>Select</th><th>Title</th><th>Price</th><th>Area</th><th>Score</th><th>Deal Strength</th></tr>
                        </thead>
                        <tbody id="results-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="comparison-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="modal-close-btn">&times;</button>
            <h2>Side-by-Side Comparison</h2>
            <div class="comparison-grid" id="comparison-body">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiBaseUrl = 'https://deal-hunter-api.onrender.com';
            const loader = document.getElementById('loader');
            const dashboardContent = document.getElementById('dashboard-content');
            let allProperties = []; 

            // --- DATA FETCHING ---
            fetch(`${apiBaseUrl}/results`)
                .then(response => response.json())
                .then(data => {
                    if (data.properties && data.properties.length > 0) {
                        allProperties = data.properties;
                        loader.style.display = 'none';
                        dashboardContent.style.display = 'block';
                        initializeDashboard(allProperties);
                    } else {
                        loader.innerHTML = '<p>The database is empty. The daily automated scraper will populate it soon.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    loader.innerHTML = '<p>Failed to load data from the API. The server may be starting up.</p>';
                });

            // --- INITIALIZE DASHBOARD ---
            function initializeDashboard(properties) {
                displayKPIs(properties);
                displayFilters(properties);
                runDisplayLogic(properties); // Initial display
                setupCompareButton(properties);
            }

            // --- DISPLAY LOGIC ---
            function displayKPIs(properties) {
                const totalDeals = properties.length;
                const avgCapRate = properties.reduce((sum, p) => sum + p.cap_rate, 0) / totalDeals;
                const avgCocReturn = properties.reduce((sum, p) => sum + p.cash_on_cash_return, 0) / totalDeals;
                
                document.getElementById('total-deals').innerText = totalDeals;
                document.getElementById('avg-cap-rate').innerText = `${avgCapRate.toFixed(2)}%`;
                document.getElementById('avg-coc-return').innerText = `${avgCocReturn.toFixed(2)}%`;
            }

            function displayFilters(properties) {
                const bedroomFilter = document.getElementById('bedrooms-filter');
                const bedroomOptions = [...new Set(properties.map(p => p.bedrooms.trim()).filter(b => b && b !== 'N/A'))].sort();
                bedroomFilter.innerHTML = '<option value="all">All Bedrooms</option>';
                bedroomOptions.forEach(option => bedroomFilter.innerHTML += `<option value="${option}">${option}</option>`);
                bedroomFilter.addEventListener('change', () => runDisplayLogic(allProperties));
            }

            function runDisplayLogic(properties) {
                const bedroomFilterValue = document.getElementById('bedrooms-filter').value;
                const filtered = properties.filter(p => bedroomFilterValue === 'all' || p.bedrooms.trim() === bedroomFilterValue);
                populateTable(filtered);
            }

            function populateTable(properties) {
                const tableBody = document.getElementById('results-body');
                tableBody.innerHTML = '';
                properties.forEach((prop, index) => {
                    const strength = getDealStrength(prop.investment_score);
                    let row = tableBody.insertRow();
                    row.innerHTML = `
                        <td><input type="checkbox" class="compare-checkbox" data-index="${index}"></td>
                        <td>${prop.title}</td>
                        <td>${prop.price_text}</td>
                        <td>${prop.area_sqft}</td>
                        <td><b class="score">${prop.investment_score.toFixed(2)}</b></td>
                        <td><span class="strength-tag ${strength.class}">${strength.text}</span></td>
                    `;
                });
            }

            // --- UNIQUE FEATURES LOGIC ---
            function getDealStrength(score) {
                if (score > 10) return { text: 'Excellent Deal', class: 'excellent' };
                if (score > 5) return { text: 'Good Value', class: 'good' };
                if (score > 0) return { text: 'Fair Price', class: 'fair' };
                return { text: 'Overpriced', class: 'overpriced' };
            }

            function setupCompareButton() {
                const compareBtn = document.getElementById('compare-btn');
                const modal = document.getElementById('comparison-modal');
                
                document.body.addEventListener('change', (e) => {
                    if (e.target.classList.contains('compare-checkbox')) {
                        const selectedCount = document.querySelectorAll('.compare-checkbox:checked').length;
                        compareBtn.style.display = selectedCount >= 2 ? 'block' : 'none';
                    }
                });

                compareBtn.addEventListener('click', () => {
                    const selected = document.querySelectorAll('.compare-checkbox:checked');
                    if (selected.length < 2 || selected.length > 3) {
                        alert('Please select 2 or 3 properties to compare.');
                        return;
                    }
                    const comparisonBody = document.getElementById('comparison-body');
                    comparisonBody.innerHTML = '';
                    selected.forEach(checkbox => {
                        const prop = allProperties[checkbox.dataset.index];
                        comparisonBody.innerHTML += `
                            <div class="comparison-col">
                                <h4>${prop.title}</h4> <hr>
                                <p>${prop.price_text}</p> <h4>Price</h4> <hr>
                                <p>${prop.area_sqft}</p> <h4>Area</h4> <hr>
                                <p class="${getDealStrength(prop.investment_score).class}">${prop.investment_score.toFixed(2)}</p> <h4>Score</h4>
                            </div>
                        `;
                    });
                    modal.style.display = 'flex';
                });

                document.getElementById('modal-close-btn').addEventListener('click', () => modal.style.display = 'none');
            }
        });
    </script>
</body>
</html>
